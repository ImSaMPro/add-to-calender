/* Add To Calendar
 *  jQuery plugin
 * ================
 *
 * @Author  Soumyadeep Mandal
 * @version 1.0.0
 */
(function (a) {
  "use strict";
  a.fn.addToCalendar = function (b) {
    var c = {},
      d = a.extend(
        {
          filename: "sample",
          target: "_blank",
          providers: {
            google: "Google Calendar",
            outlook: "Outlook Live",
            yahoo: "Yahoo! Calendar",
            other: "Other Calendar",
          },
          onAddEvent: function () {},
        },
        b
      ),
      e = function (a, b) {
        var c, e, f, h, i, j, k;
        if (
          ((c = void 0 === b.title ? "" : b.title),
          (e = void 0 === b.start ? new Date().toISOString() : g(b.start)),
          (f = void 0 === b.end ? new Date().toISOString() : g(b.end)),
          (h = void 0 === b.desc ? "" : b.desc),
          (i = void 0 === b.location ? "" : b.location),
          (k = void 0 === b.timezone ? "" : b.timezone),
          "google" === a)
        )
          (j = "http://www.google.com/calendar/render?action=TEMPLATE"),
            (j += "&text=" + encodeURIComponent(c)),
            (j += "&dates=" + encodeURIComponent(e + "/" + f)),
            (j += "&details=" + encodeURIComponent(h)),
            (j += "&location=" + encodeURIComponent(i)),
            (j += k ? "&ctz=" + encodeURIComponent(k) : ""),
            (j += "&output=xml"),
            window.open(j, d.target);
        else if ("outlook" === a)
          (e = g(b.start, "outlook")),
            (f = g(b.end, "outlook")),
            (j =
              "https://outlook.live.com/owa/?path=/calendar/action/compose&rru=addevent&subject=" +
              encodeURIComponent(c) +
              "&startdt=" +
              encodeURIComponent(e) +
              "&enddt=" +
              encodeURIComponent(f) +
              "&body=" +
              encodeURIComponent(h) +
              "&location=" +
              encodeURIComponent(i)),
            window.open(j, d.target);
        else if ("yahoo" === a)
          (j =
            "https://calendar.yahoo.com/?v=60&view=d&type=20&title=" +
            encodeURIComponent(c) +
            "&st=" +
            encodeURIComponent(e) +
            "&et=" +
            encodeURIComponent(f) +
            "&desc=" +
            encodeURIComponent(h) +
            "&in_loc=" +
            encodeURIComponent(i)),
            window.open(j, d.target);
        else if ("other" === a) {
          var l,
            m = d.filename + ".ics",
            n = new Date()
              .toISOString()
              .split(".")[0]
              .replace(/[/]|-|:/g, ""),
            o = "BEGIN:VCALENDAR\n";
          (o += "VERSION:2.0\n"),
            (o += "BEGIN:VEVENT\n"),
            (o += "DTSTAMP:" + n + "\n"),
            (o += "STATUS:CONFIRMED\n"),
            (o += "UID:" + new Date().getTime() + "addtocalendar\n"),
            (o +=
              "" === k
                ? "DTSTART=" + e + "\n"
                : "DTSTART;TZID=" + k + ":" + e + "\n"),
            (o +=
              "" === k
                ? "DTEND=" + e + "\n"
                : "DTEND;TZID=" + k + ":" + f + "\n"),
            (o += "SUMMARY:" + c + "\n"),
            (o += "DESCRIPTION:" + h + "\n"),
            (o += "X-ALT-DESC;FMTTYPE=text/html:" + h + "\n"),
            (o += "LOCATION:" + i + "\n"),
            (o += "BEGIN:VALARM\n"),
            (o += "TRIGGER:-PT15M\n"),
            (o += "ACTION:DISPLAY\n"),
            (o += "END:VALARM\n"),
            (o += "TRANSP:OPAQUE\n"),
            (o += "END:VEVENT\n"),
            (o += "END:VCALENDAR"),
            (l = document.createElement("a")),
            l.setAttribute(
              "href",
              "data:text/calendar;charset=utf-8," + encodeURIComponent(o)
            ),
            l.setAttribute("download", m),
            (l.style.display = "none"),
            document.body.appendChild(l),
            l.click(),
            document.body.removeChild(l);
        } else return !1;
        return !0;
      },
      f = function (a) {
        var b = document.createElement("ul");
        return (
          (b.className = "cal-clients"),
          Object.keys(a).forEach(function (c) {
            var d = document.createElement("li");
            (d.textContent = a[c]),
              (d.className = c.toLowerCase()),
              b.appendChild(d);
          }),
          b
        );
      },
      g = function (a, b) {
        return (
          "outlook" === b
            ? ((a = a.replace(/\//g, "-") + ":00"), (a = a.replace(/\s/, "T")))
            : ((a = a.replace(/-|:|[/]|\.\d\d\d/g, "") + "00"),
              (a = a.replace(/\s/, "T"))),
          a
        );
      };
    return this.each(function () {
      var b = a(this);
      b.append(new f(d.providers))
        .mouseleave(function () {
          var b = a(this).find(".cal-clients");
          a(document).click(function () {
            b.removeClass("is-open"), a(document).unbind("click");
          });
        })
        .on("click", function (b) {
          var d = a(this).find(".cal-clients");
          b.preventDefault(),
            (c = a(this).data("event")),
            d.addClass("is-open");
        })
        .on("click", "li", function () {
          var b = a(this).attr("class");
          e(b, c), d.onAddEvent.call(this);
        });
    });
  };
})(jQuery);
